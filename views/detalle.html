<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detalle del Producto - EcoMarket</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <!-- Estilos personalizados -->
    <link rel="stylesheet" href="../css/styles.css">
    <link rel="stylesheet" href="../css/responsive.css">
</head>
<body>
    <!-- Header -->
    <div id="header"></div>

    <!-- Contenido Principal -->
    <main class="container py-5">
        <div class="row mb-3">
            <div class="col-12">
                <a href="javascript:history.back()" class="btn btn-outline-secondary btn-sm">
                    <i class="bi bi-arrow-left"></i> Volver
                </a>
            </div>
        </div>

        <div id="productDetail">
            <!-- Contenido del producto se carga aquí -->
            <div class="text-center py-5">
                <div class="spinner-border text-success" role="status">
                    <span class="visually-hidden">Cargando...</span>
                </div>
            </div>
        </div>

        <!-- Productos Relacionados -->
        <div class="row mt-5">
            <div class="col-12">
                <h3 class="mb-4">Productos Relacionados</h3>
                <div id="relatedProducts" class="row g-4">
                    <!-- Productos relacionados se cargan aquí -->
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <div id="footer"></div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../js/storage.js"></script>
    <script src="../js/utils.js"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/categories.js"></script>
    <script src="../js/products.js"></script>
    <script src="../js/cart.js"></script>
    <script src="../js/app.js"></script>
    <script>
        const ProductDetailManager = {
            product: null,
            productId: null,

            init: function() {
                // Obtener ID del producto de la URL
                const urlParams = new URLSearchParams(window.location.search);
                this.productId = urlParams.get('id');

                if (!this.productId) {
                    this.showError('Producto no encontrado');
                    return;
                }

                this.loadProduct();
            },

            loadProduct: function() {
                this.product = StorageManager.readById('products', this.productId);

                if (!this.product) {
                    this.showError('Producto no encontrado');
                    return;
                }

                this.renderProduct();
                this.loadRelatedProducts();
            },

            renderProduct: function() {
                const categories = StorageManager.readAll('categories');
                const category = categories.find(c => c.id === this.product.categoryId);
                const categoryName = category ? category.name : 'Sin categoría';

                const container = document.getElementById('productDetail');
                container.innerHTML = `
                    <div class="row">
                        <!-- Imagen del Producto -->
                        <div class="col-md-6 mb-4">
                            <div class="card shadow-sm">
                                <img src="${this.product.image}" class="card-img-top" alt="${Utils.sanitizeHTML(this.product.name)}" 
                                     style="width: 100%; height: 500px; object-fit: cover;">
                            </div>
                        </div>

                        <!-- Información del Producto -->
                        <div class="col-md-6">
                            <div class="mb-3">
                                <h1 class="display-5 fw-bold">${Utils.sanitizeHTML(this.product.name)}</h1>
                                <p class="text-muted">
                                    <i class="bi bi-tag"></i> ${Utils.sanitizeHTML(categoryName)}
                                </p>
                            </div>

                            <!-- Precio -->
                            <div class="mb-4">
                                <h2 class="text-success mb-0">${Utils.formatPrice(this.product.price)}</h2>
                            </div>

                            <!-- Etiquetas Ecológicas -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-2">Certificaciones Ecológicas:</h6>
                                ${Utils.generateEcoLabels(this.product.ecoLabels)}
                            </div>

                            <!-- Descripción -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-2">Descripción:</h6>
                                <p class="text-justify">${Utils.sanitizeHTML(this.product.description)}</p>
                            </div>

                            <!-- Información Adicional -->
                            <div class="mb-4">
                                <h6 class="fw-bold mb-2">Información del Producto:</h6>
                                <ul class="list-unstyled">
                                    <li><i class="bi bi-calendar3 text-muted"></i> Fecha de registro: ${this.product.registrationDate}</li>
                                </ul>
                            </div>

                            <!-- Acciones -->
                            <div class="d-grid gap-3">
                                <button class="btn btn-success btn-lg" onclick="ProductDetailManager.addToCart()">
                                    <i class="bi bi-cart-plus"></i> Agregar al Carrito
                                </button>
                                <a href="catalogo.html" class="btn btn-outline-secondary">
                                    <i class="bi bi-arrow-left"></i> Volver al Catálogo
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            },

            addToCart: function() {
                if (typeof CartManager !== 'undefined') {
                    CartManager.addToCart(this.productId);
                }
            },

            loadRelatedProducts: function() {
                const allProducts = StorageManager.readAll('products');
                
                // Productos de la misma categoría, excluyendo el actual
                const related = allProducts
                    .filter(p => p.categoryId === this.product.categoryId && p.id !== this.product.id)
                    .slice(0, 4);

                const container = document.getElementById('relatedProducts');
                
                if (related.length === 0) {
                    container.innerHTML = '<p class="text-muted">No hay productos relacionados disponibles</p>';
                    return;
                }

                container.innerHTML = related.map(p => this.createRelatedCard(p)).join('');
            },

            createRelatedCard: function(product) {
                return `
                    <div class="col-md-6 col-lg-3">
                        <div class="card h-100 shadow-sm">
                            <img src="${product.image}" class="card-img-top" alt="${Utils.sanitizeHTML(product.name)}" 
                                 style="height: 150px; object-fit: cover;">
                            <div class="card-body d-flex flex-column">
                                <h6 class="card-title">${Utils.sanitizeHTML(product.name)}</h6>
                                <p class="text-success fw-bold mb-2">${Utils.formatPrice(product.price)}</p>
                                <a href="detalle.html?id=${product.id}" class="btn btn-sm btn-outline-success mt-auto">
                                    Ver Detalle
                                </a>
                            </div>
                        </div>
                    </div>
                `;
            },

            showError: function(message) {
                const container = document.getElementById('productDetail');
                container.innerHTML = `
                    <div class="alert alert-danger text-center" role="alert">
                        <i class="bi bi-exclamation-triangle display-4"></i>
                        <h4 class="mt-3">${message}</h4>
                        <a href="catalogo.html" class="btn btn-success mt-3">Ir al Catálogo</a>
                    </div>
                `;
            }
        };

        // Inicializar
        document.addEventListener('DOMContentLoaded', function() {
            // Cargar componentes
            if (typeof EcoMarketApp !== 'undefined') {
                EcoMarketApp.loadComponents();
                EcoMarketApp.checkAuthentication();
            }
            
            // Inicializar carrito y detalle
            setTimeout(() => {
                if (typeof CartManager !== 'undefined') {
                    CartManager.init();
                }
                ProductDetailManager.init();
            }, 100);
        });
    </script>
</body>
</html>
